<!DOCTYPE html>

<html><head>
  <script src="lightgl.js"></script>
  <script src="csg.js"></script>
  <script src="openjscad.js"></script>
  <style>

body {
  font: 14px/20px 'Helvetica Neue Light', HelveticaNeue-Light, 'Helvetica Neue', Helvetica, Arial, sans-serif;
  max-width: 820px;
  margin: 0 auto;
  padding: 10px;
}

pre, code, textarea {
  font: 12px/20px Monaco, monospace;
  border: 1px solid #CCC;
  border-radius: 3px;
  background: #F9F9F9;
  padding: 0 3px;
  color: #555;
}
pre, textarea {
  padding: 10px;
  width: 100%;
}
textarea {
  height: 200px;
}
textarea:focus {
  outline: none;
}

canvas { cursor: move; }

  </style>
<link rel="stylesheet" href="openjscad.css" type="text/css">

<script>

var gProcessor=null;

// Show all exceptions to the user:
OpenJsCad.AlertUserOfUncaughtExceptions();

function onload()
{
  gProcessor = new OpenJsCad.Processor(document.getElementById("viewer"));
  updateSolid();
}

function updateSolid()
{
  gProcessor.setJsCad(document.getElementById('code').value);
}
</script>
<title>OpenJsCad demo: 2d geometry with curved wall</title>  
</head>
<body onload="onload()">
  <h1>OpenJsCad demo: 2D geometry with curved wall</h1>
<div id="viewer"></div>
  <h2>Source code</h2>
Below is the OpenJsCad script for this demo. To build your own models, create a .jscad script
and use the <a href="processfile.html"><b>OpenJsCad parser</b></a>. For more information see the
<a href="index.html">OpenJsCad documentation</a>. 
<br><br> 
<textarea id="code">
function getParameterDefinitions() {
	return [
{ name: 'Hstrip', caption: 'Hight of the vertical strip :', type: 'float', default: 80 },
	{ name: 'xinlet', caption: 'X position of the inlet:', type: 'float', default: 30 },
	{ name: 'yinlet', caption: 'Y position of the inlet:', type: 'float', default: 70 },
	{ name: 'Hinlet', caption: 'Height of the inlet:', type: 'float', default: 4 },
	{ name: 'Linlet', caption: 'Length of the inlet:', type: 'float', default: 10 },
	{ name: 'Dzinc', caption: 'Thicknes  of final layer:', type: 'float', default: 0.05 },
	{ name: 'Lzinc', caption: 'Length  of meniscus from outlet:', type: 'float', default: 1.0 },
	{ name: 'nfoilpoints', caption: 'Resolution of the strip:', type: 'float', default: 100 },
	{ name: 'Rcircle', caption: 'Radius of the circel connecting inlet and foil:', type: 'float', default: 15 },
	{ name: 'alpha', caption: 'Fraction of radius where circel cuts the foil', type: 'float', default: 0.7 },
	{ name: 'foily0', caption: 'Bottom position of the foil', type: 'float', default: 0 },
	{ name: 'foilx0', caption: 'Initial distrance of foil from strip at bottom (y=0)', type: 'float', default: 0.01},
	{ name: 'foildxr', caption: 'Distrance of foil from strip at reference point y=yr', type: 'float', default: 0.05},
	{ name: 'foilyr', caption: 'Reference point y=yr', type: 'float', default: 20},
	{ name: 'rcorner', caption: 'Radius of curvature at corner inlet', type: 'float', default: 2},
	];
}
function main(params) {
	// nice 2D geometry based on a functional description

	// set up some position vectors
	var foilbot= new CSG.Vector2D([params.foilx0,params.foily0]) ;
	var foilref= new CSG.Vector2D([params.foilx0+params.foildxr,params.foilyr]) ;

	var inletbot =new CSG.Vector2D([params.xinlet,params.yinlet]) ; 
	var inletdim =new CSG.Vector2D([params.Linlet,params.Hinlet]) ; 
	var inlettop =new CSG.Vector2D([params.xinlet,params.yinlet+params.Hinlet]) ; 
	var zinctop  =new CSG.Vector2D([params.xinlet-params.Linlet,params.Hstrip]) ; 
	var striptop =new CSG.Vector2D([0,params.Hstrip]) ; 

	// create the functional description
	var foilCAG=makeFoilCAG(
			params.nfoilpoints,
			foilbot,
			foilref,
			params.Hstrip,
			params.Linlet);
	
	// create circular connection 
	var circularCAG=makeCircularCAG(
		inletbot,
		inletdim,
		foilbot,
		foilref,
		params.Rcircle,
		params.alpha
		);

	// create the square and tube
	var zincbathCAG=makeZincBathCAG(
			inlettop,
			inletbot,
			inletdim,
			striptop,
			zinctop,
			params.rcorner
			);

	var meniscusCAG=makeOutletMeniscusCAG(
			foilbot,
			params.Dzinc,
			params.Lzinc
			);



	// put it all together and return
	foilCAG=foilCAG.union([zincbathCAG,circularCAG,meniscusCAG]);
	//
	// for debugging the outlet: cut away the rest
	//cutblock=CAG.rectangle({corner1: [0,-0.1],corner2: [1,0.01]});
	//foilCAG=foilCAG.intersect([cutblock]);
	//foilCAG=foilCAG.scale(1000);

	return [
	{
		name : "foilCAG",
	 	caption: "Foil ",
		data: foilCAG,
	},
	];
}
function powerfun(x,dh,hr,h0)
{
	// the mathematical function 
	// x(y)=  dxr*(y/yr)^4+x0
	return dh*Math.pow(x/hr,4)+h0;
}

function makeFoilCAG(npoint,foilbot,foilref,Lfoil)
{
	// create the functional geometry
	
	var dy=Lfoil/(npoint-1);

	// increase in distance from bottom to reference point at yref
	var dxr=foilref.x-foilbot.x

	// start at x=0 at the bottom 
	var foilpath = new CSG.Path2D([[0,foilbot.y]]);

	// draw the curved wall from the bottom to the top
	//debugger;
	for(var i=0;i<npoint;i++)
	{
		var yp=i*dy;
		var xp=powerfun(yp,dxr,foilref.y,foilbot.x);
		foilpath = foilpath.appendPoint([xp,yp]);
	}

	// make a closed CAG out of it
	foilpath = foilpath.appendPoint([0,foilbot.y+Lfoil]);
	foilpath = foilpath.close();
	return foilpath.innerToCAG();
}
	
function makeCircularCAG(
		inletbot,
		inletdim,
		foilbot,
		foilref,
		Rcircle,
		alpha
		)
{
	// create circular connection between inlet and foil
	var dxr=foilref.x-foilbot.x
	var ytang=inletbot.y-alpha*Rcircle;
	var xtang=powerfun(ytang,dxr,foilref.y,foilbot.x)

	var curvedpath=new CSG.Path2D(
			[
				[inletbot.x-inletdim.x/2.	,inletbot.y],
				[inletbot.x-inletdim.x		,inletbot.y]
			]);
	curvedpath=curvedpath.appendArc(
			[xtang,ytang],
			{
					xradius: Rcircle,
					yradius: Rcircle,
					xaxisrotation: 0,
					resolution: 512,
					clockwise: false,
					large: false,
			});
	curvedpath=curvedpath.appendPoint([0,ytang]);
	curvedpath=curvedpath.appendPoint([0,inletbot.y+inletdim.y]);
	curvedpath=curvedpath.appendPoint([inletbot.x-inletdim.x/2,inletbot.y+inletdim.y]);
	curvedpath=curvedpath.close();
    return	curvedpath.innerToCAG();

}

	// create the bath and inlet
function makeZincBathCAG(
			inlettop,
			inletbot,
			inletdim,
			striptop,
			zinctop,
			rcorner)
{
	// create bath and inlet connected to it
	inletandbath=CAG.rectangle({corner1: inletbot,corner2: striptop});

	var topblocks 	= new CAG();
	var topblock=CAG.roundedRectangle({corner1: inlettop,corner2: zinctop,
 		roundradius: rcorner, resolution: 512});
	var topblocksx	= topblock.translate([inletdim.x/2.0,0]);
	var topblocksy	= topblock.translate([0,rcorner]);
	topblocks		= topblock;
	topblocks		= topblocks.union([topblocksx,topblocksy]) ;

	return  inletandbath.subtract(topblocks);
}

function makeOutletMeniscusCAG(
			foilbot,
			Dzinc,
			Lzinc
			)
{
	var yp=-0.02;
	var Rx= -0.15;
	var Ry= 0.035;
	var curvedpath=new CSG.Path2D(
			[
				[foilbot.x	,foilbot.y]
			]);
	curvedpath=curvedpath.appendArc(
			[Dzinc,yp],
			{
					xradius: Rx,
					yradius: Ry,
					xaxisrotation: -70,
					resolution: 512,
					clockwise: false,
					large: false,
			});
	curvedpath=curvedpath.appendPoint([Dzinc,-Lzinc]);
	curvedpath=curvedpath.appendPoint([0,-Lzinc]);
	curvedpath=curvedpath.appendPoint([0,0]);
	curvedpath=curvedpath.close();
    return	curvedpath.innerToCAG();
}
</textarea><br>
<input type="submit" value="Update" onclick="updateSolid(); return false;">
<br><br>
</body>
</html>
